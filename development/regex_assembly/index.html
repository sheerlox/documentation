<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.97.3"><meta name=description content="CoreRuleSet Documentation"><meta name=author content="CoreRuleSet"><link rel=icon href=/documentation/images/favicon.png type=image/png><title>Assembling Regular Expressions :: Core Rule Set Documentation</title><link href=/documentation/css/nucleus.css?1685994226 rel=stylesheet><link href=/documentation/css/fontawesome-all.min.css?1685994226 rel=stylesheet><link href=/documentation/css/featherlight.min.css?1685994226 rel=stylesheet><link href=/documentation/css/perfect-scrollbar.min.css?1685994226 rel=stylesheet><link href=/documentation/css/auto-complete.css?1685994226 rel=stylesheet><link href=/documentation/css/theme.css?1685994226 rel=stylesheet><link href=/documentation/css/theme-blue.css?1685994226 rel=stylesheet><link href=/documentation/css/variant.css?1685994226 rel=stylesheet><link href=/documentation/css/print.css?1685994226 rel=stylesheet media=print><script src=/documentation/js/jquery.min.js?1685994226></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/documentation/development/regex_assembly/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=https://coreruleset.github.io/documentation/><img src=https://coreruleset.github.io/documentation//images/logo.png></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script src=/documentation/js/lunr.min.js?1685994226></script>
<script src=/documentation/js/auto-complete.js?1685994226></script>
<script>var index_url="/documentation/index.json",root_url="/",baseUri=root_url.replace(/\/$/,'')</script><script src=/documentation/js/search.js?1685994226></script></div><div id=homelinks><ul><li><a class=padding href=/documentation/><i class="fas fa-home"></i> Home</a></li></ul></div><div class=highlightable><ul class=topics><li data-nav-id=/documentation/deployment/ title="Getting CRS" class=dd-item><a href=/documentation/deployment/><b>1. </b>Getting CRS<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/deployment/engine_integration_options/ title="Engine and Integration Options" class=dd-item><a href=/documentation/deployment/engine_integration_options/>Engine and Integration Options<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/deployment/quick_start/ title="Quick Start Guide" class=dd-item><a href=/documentation/deployment/quick_start/>Quick Start Guide<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/deployment/install/ title="Extended Install" class=dd-item><a href=/documentation/deployment/install/>Extended Install<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/concepts/ title="How CRS Works" class=dd-item><a href=/documentation/concepts/><b>2. </b>How CRS Works<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/concepts/anomaly_scoring/ title="Anomaly Scoring" class=dd-item><a href=/documentation/concepts/anomaly_scoring/>Anomaly Scoring<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/concepts/paranoia_levels/ title="Paranoia Levels" class=dd-item><a href=/documentation/concepts/paranoia_levels/>Paranoia Levels<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/concepts/false_positives_tuning/ title="False Positives and Tuning" class=dd-item><a href=/documentation/concepts/false_positives_tuning/>False Positives and Tuning<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/concepts/plugins/ title="Plugin Mechanism" class=dd-item><a href=/documentation/concepts/plugins/>Plugin Mechanism<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/concepts/sampling_mode/ title="Sampling Mode" class=dd-item><a href=/documentation/concepts/sampling_mode/>Sampling Mode<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/operation/ title=Operation class=dd-item><a href=/documentation/operation/><b>3. </b>Operation<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/operation/known_issues/ title="Known Issues" class=dd-item><a href=/documentation/operation/known_issues/>Known Issues<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/operation/containers/ title="Using Containers" class=dd-item><a href=/documentation/operation/containers/>Using Containers<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/operation/kubernetes_ingress/ title="Kubernetes Ingress Controllers" class=dd-item><a href=/documentation/operation/kubernetes_ingress/>Kubernetes Ingress Controllers<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/operation/log_handling/ title="Log Handling" class=dd-item><a href=/documentation/operation/log_handling/>Log Handling<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/rules/ title=Rules class=dd-item><a href=/documentation/rules/><b>4. </b>Rules<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/rules/ruleid/ title="Rule IDs" class=dd-item><a href=/documentation/rules/ruleid/>Rule IDs<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/rules/ title=Rules class=dd-item><a href=/documentation/rules/rules/>Rules<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/creating/ title=Making class=dd-item><a href=/documentation/rules/creating/>Making<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/metadata/ title=Metadata class=dd-item><a href=/documentation/rules/metadata/>Metadata<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/development/ title=Development class="dd-item parent"><a href=/documentation/development/><b>5. </b>Development<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/development/contribution_guidelines/ title="Contribution Guidelines" class=dd-item><a href=/documentation/development/contribution_guidelines/>Contribution Guidelines<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/crs_toolchain/ title=crs-toolchain class=dd-item><a href=/documentation/development/crs_toolchain/>crs-toolchain<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/regex_assembly/ title="Assembling Regular Expressions" class="dd-item active"><a href=/documentation/development/regex_assembly/>Assembling Regular Expressions<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/rule_writing/ title="Writing Rules" class=dd-item><a href=/documentation/development/rule_writing/>Writing Rules<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/useful_tools/ title="Useful Tools" class=dd-item><a href=/documentation/development/useful_tools/>Useful Tools<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/testing/ title="Testing the Rule Set" class=dd-item><a href=/documentation/development/testing/>Testing the Rule Set<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/plugin_writing/ title="Writing Plugins" class=dd-item><a href=/documentation/development/plugin_writing/>Writing Plugins<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/sandbox/ title="Using the CRS Sandbox" class=dd-item><a href=/documentation/development/sandbox/>Using the CRS Sandbox<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/resources/ title="Additional Resources" class=dd-item><a href=/documentation/resources/><b>6. </b>Additional Resources<i class="fas fa-check read-icon"></i></a><ul></ul></li><li data-nav-id=/documentation/miscellaneous/ title=Miscellaneous class=dd-item><a href=/documentation/miscellaneous/><b>7. </b>Miscellaneous<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/miscellaneous/self_contained_mode/ title="Self-Contained Mode" class=dd-item><a href=/documentation/miscellaneous/self_contained_mode/>Self-Contained Mode<i class="fas fa-check read-icon"></i></a></li></ul></li></ul><div id=shortcuts><div class=nav-title>More</div><ul><li><a class=padding href=https://coreruleset.org/><i class="fas fa-bookmark"></i> Core Rule Set Home</a></li><li><a class=padding href=https://github.com/coreruleset/coreruleset><i class="fab fa-github"></i> Core Rule Set GitHub</a></li></ul></div><div id=prefooter><hr><ul><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li></ul></div><div id=footer><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></nav><div id=body><div id=overlay></div><div class="padding highlightable"><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/coreruleset/documentation/blob/main/content/development/regex_assembly.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Assembling Regular Expressions</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#specification-format>Specification Format</a><ul><li><a href=#example>Example</a></li><li><a href=#comments>Comments</a></li><li><a href=#empty-lines>Empty Lines</a></li><li><a href=#flag-marker>Flag Marker</a></li><li><a href=#prefix-marker>Prefix Marker</a></li><li><a href=#suffix-marker>Suffix Marker</a></li><li><a href=#processor-marker>Processor Marker</a></li><li><a href=#nesting>Nesting</a></li></ul></li><li><a href=#command-line-evasion-processor>Command Line Evasion processor</a><ul><li><a href=#arguments>Arguments</a></li><li><a href=#output>Output</a></li><li><a href=#description>Description</a></li></ul></li><li><a href=#assemble-processor>Assemble processor</a><ul><li><a href=#arguments-1>Arguments</a></li><li><a href=#output-1>Output</a></li><li><a href=#description-1>Description</a></li></ul></li><li><a href=#definition-processor>Definition processor</a><ul><li><a href=#arguments-2>Arguments</a></li><li><a href=#output-2>Output</a></li><li><a href=#description-2>Description</a></li></ul></li><li><a href=#include-processor>Include processor</a><ul><li><a href=#arguments-3>Arguments</a></li><li><a href=#output-3>Output</a></li><li><a href=#description-3>Description</a></li></ul></li><li><a href=#include-except-processor>Include-Except processor</a><ul><li><a href=#arguments-4>Arguments</a></li><li><a href=#output-4>Output</a></li><li><a href=#description-4>Description</a></li></ul></li></ul></nav></div></div></div><div id=head-tags></div><main id=body-inner><h1>Assembling Regular Expressions</h1><blockquote><p>The CRS team uses a custom specification format to specify how a regular expression is to be generated from its components. This format enables reuse across different files, explanation of choices and techniques with comments, and specialized processing.</p></blockquote><h2 id=specification-format>Specification Format</h2><p>The files containing regular expression specifications (<code>.ra</code> suffix, under <code>regex-assembly</code>) contain one regular expression per line. These files are meant to be processed by the <a href=/documentation/development/crs_toolchain/>crs-toolchain</a>.</p><h3 id=example>Example</h3><p>The following is an example of what an assembly file might contain:</p><pre tabindex=0><code>##! This line is a comment and will be ignored. The next line is empty and will also be ignored.

##! The next line sets the *ignore case* flag on the resulting expression:
##!+ i

##! The next line is the prefix comment. The assembled expression will be prefixed with its contents:
##!^ \b

##! The next line is the suffix comment. The assembled expression will be suffixed with its contents:
##!$ \W*\(

##! The following two lines are regular expressions that will be assembled:
--a--
__b__

##! Another comment, followed by another regular expression:
^#!/bin/bash
</code></pre><p>This assembly file would produce the following assembled expression: <code>(?i)\b(?:--a--|__b__|^#!/bin/bash)[^0-9A-Z_a-z]*\(</code></p><h3 id=comments>Comments</h3><p>Lines starting with <code>##!</code> are considered comments and will be skipped. Use comments to explain the purpose of a particular regular expression, its use cases, origin, shortcomings, etc. Having more information recorded about individual expressions will allow developers to better understand changes or change requirements, such as when reviewing pull requests.</p><h3 id=empty-lines>Empty Lines</h3><p>Empty lines, i.e., lines containing only white space, will be skipped. Empty lines can be used to improve readability, especially when adding comments.</p><h3 id=flag-marker>Flag Marker</h3><p>A line starting with <code>##!+</code> can be used to specify global flags for the regular expression engine. The flags from all lines starting with the flag marker will be combined. The resulting expression will be prefixed with the flags. For example, the two lines</p><pre tabindex=0><code>##!+ i
a+b|c
</code></pre><p>will produce the regular expression <code>(?i)a+b|c</code>.</p><p>The following flags are currently supported:</p><ul><li><code>i</code>: ignore case; matches will be case-insensitive</li><li><code>s</code>: make <code>.</code> match newline (<code>\n</code>); this set by ModSecurity anyway and is included here for backward compatibility</li></ul><h3 id=prefix-marker>Prefix Marker</h3><p>A line starting with <code>##!^</code> can be used to pass a global prefix to the script. The resulting expression will be prefixed with the literal contents of the line. Multiple prefix lines will be concatenated in order. For example, the lines</p><pre tabindex=0><code>##!^ \d*\(
##!^ simpson
marge|homer
</code></pre><p>will produce the regular expression <code>[0-9]*\(simpson(?:marge|homer)</code>.</p><p>The prefix marker exists for convenience and improved readability. The same can be achieved with the <a href=#assemble-processor>assemble processor</a>.</p><h3 id=suffix-marker>Suffix Marker</h3><p>A line starting with <code>##!$</code> can be used to pass a suffix to the script. The resulting expression will be suffixed with the literal contents of the line. Multiple suffix lines will be concatenated in order. For example, the lines</p><pre tabindex=0><code>##!$ \d*\(
##!$ simpson
marge|homer
</code></pre><p>will produce the regular expression <code>(?:marge|homer)[0-9]*\(simpson</code>.</p><p>The suffix marker exists for convenience and improved readability. The same can be achieved with the <a href=#assemble-processor>assemble processor</a>.</p><h3 id=processor-marker>Processor Marker</h3><p>A line starting with <code>##!></code> is a processor directive. The processor marker can be used to preprocess a block of lines.</p><p>A line starting with <code>##!&lt;</code> marks the end of the most recent processor block.</p><p>Processor markers have the following general format: <code>&lt;marker> &lt;processor name> [&lt;processor arguments>]</code>. For example: <code>##!> cmdline unix</code>. The arguments depend on the processor and may be empty.</p><p>The following example is intentionanlly simple (and meaningless) to illustrates the use of the markers without adding additionally confusing pieces. Please refer to the following sections for more concrete and useful examples.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>##!&gt; cmdline unix</span>
</span></span><span style=display:flex><span>  command1
</span></span><span style=display:flex><span>  command2
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!&gt; assemble</span>
</span></span><span style=display:flex><span>    nested1
</span></span><span style=display:flex><span>    nested2
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!&lt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##!&lt;</span>
</span></span></code></pre></div><p>Processors are defined in the <a href=/documentation/development/crs_toolchain/>crs-toolchain</a>.</p><h3 id=nesting>Nesting</h3><p>Processors may be nested. This enables complex scenarios, such as assembling a smaller expression to concatenate it with another line or block of lines. For example, the following will produce the regular expression <code>line1(?:ab|cd)</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>##!&gt; assemble</span>
</span></span><span style=display:flex><span>line1
</span></span><span style=display:flex><span><span style=color:#75715e>##!=&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!&gt; assemble</span>
</span></span><span style=display:flex><span>ab
</span></span><span style=display:flex><span>cd
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!&lt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##!&lt;</span>
</span></span></code></pre></div><p>There is no practical limit to the nesting depth.</p><p>Each processor block must be terminated with the end marker <code>##!&lt;</code>, except for the outermost (default) block, where the end marker is optional.</p><h2 id=command-line-evasion-processor>Command Line Evasion processor</h2><p>Processor name: <code>cmdline</code></p><h3 id=arguments>Arguments</h3><p><code>unix|windows</code> (required): The processor argument determines the escaping strategy used for the regular expression. Currently, the two supported strategies are Windows cmd (<code>windows</code>) and &ldquo;unix like&rdquo; terminal (<code>unix</code>).</p><h3 id=output>Output</h3><p>One line per line of input, escaped for the specified environment.</p><h3 id=description>Description</h3><p>The command line evasion processor treats each line as a word (e.g., a shell command) that needs to be escaped.</p><p>Lines starting with a single quote <code>'</code> are treated as literals and will not be escaped.</p><p>The special token <code>@</code> will be replaced with an optional &ldquo;word ending&rdquo; regular expression. This can be used in the context of a shell to reduce the number of false positives for a word by requiring a subsequent token to be present. For example: <code>diff@</code>.</p><p><code>@</code> will match:</p><ul><li><code>python&lt;&lt;&lt;'print("hello")'</code></li><li><code>python &lt;&lt;&lt; 'print("hello")'</code></li></ul><p><code>@</code> will <em>not</em> match:</p><ul><li><code>python3&lt;&lt;&lt;'print("hello")'</code></li><li><code>python3 &lt;&lt;&lt; 'print("hello")'</code></li></ul><p>The special token <code>~</code> acts like <code>@</code> but does not allow any white space tokens to <em>immediately</em> follow the preceding word. This is useful for adding common English words to word lists. For example, there are multiple executable names for &ldquo;python&rdquo;, such as <code>python3</code> or <code>python3.8</code>. These could not be added with <code>python@</code>, as <code>python</code> would be a valid match and create many false positives.</p><p><code>~</code> will match:</p><ul><li><code>python&lt;&lt;&lt;'print("hello")'</code></li><li><code>python3 &lt;&lt;&lt; 'print("hello")'</code></li></ul><p><code>~</code> will <em>not</em> match:</p><ul><li><code>python &lt;&lt;&lt; 'print("hello")'</code></li></ul><p>The patterns that are used by the command line evasion processor are configurable. The default configuration for the Core Rule Set can be found in the <code>toolchain.yaml</code> in the <code>regex-assembly</code> directory of the <a href=https://github.com/coreruleset/coreruleset>Core Rule Set project</a>.</p><p>The following is an example of how the command line evasion processor can be used:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>##!&gt; cmdline unix</span>
</span></span><span style=display:flex><span>  w<span style=color:#f92672>@</span>
</span></span><span style=display:flex><span>  gcc<span style=color:#f92672>~</span>
</span></span><span style=display:flex><span>  <span style=color:#e6db74>&#39;python[23]</span>
</span></span><span style=display:flex><span>  aptitude<span style=color:#f92672>@</span>
</span></span><span style=display:flex><span>  pacman<span style=color:#f92672>@</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##!&lt;</span>
</span></span></code></pre></div><h2 id=assemble-processor>Assemble processor</h2><p>Processor name: <code>assemble</code></p><h3 id=arguments-1>Arguments</h3><p>This processor does not accept any arguments.</p><h3 id=output-1>Output</h3><p>Single line regular expression, where each line of the input is treated as an alternation of the regular expression. Input can also be stored or concatenated by using the two marker comments for input (<code>##!=&lt;</code>) and output (<code>##!=></code>).</p><h3 id=description-1>Description</h3><p>Each line of the input is treated as an alternation of a regular expression, processed into a single line. The resulting regular expression is not optimized (in the strict sense) but is reduced (i.e., common elements may be put into character classes or groups). The ordering of alternations in the output can differ from the order in the file (ordering alternations by length is a simple performance optimization).</p><p>This processor can also store the output of a block delimited with the input marker <code>##!=&lt;</code>, or produce the concatenation of blocks delimited with the output marker <code>##!=></code>.</p><p>Lines within blocks delimited by input or output markers are treated as alternations, as usual. The input and output markers enable more complex scenarios, such as separating parts of the regular expression in the assembly file for improved readability. Rule 930100, for example, uses separate expressions for periods and slashes, since it&rsquo;s easier to reason about the differences when they are physically separated. The following example is based on rules from 930100:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>##!&gt; assemble</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>##! slash patterns</span>
</span></span><span style=display:flex><span>  \x5c
</span></span><span style=display:flex><span>  <span style=color:#75715e>##! URI encoded</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>%</span><span style=color:#ae81ff>2</span>f
</span></span><span style=display:flex><span>  <span style=color:#f92672>%</span><span style=color:#ae81ff>5</span>c
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!=&gt;</span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span>  <span style=color:#75715e>##! dot patterns</span>
</span></span><span style=display:flex><span>  \<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>  \<span style=color:#f92672>.%</span><span style=color:#ae81ff>00</span>
</span></span><span style=display:flex><span>  \<span style=color:#f92672>.%</span><span style=color:#ae81ff>01</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##!&lt;</span>
</span></span></code></pre></div><p>The above would produce the following, concatenated regular expression:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>(<span style=color:#960050;background-color:#1e0010>?</span>:\x5c<span style=color:#f92672>|%</span>(<span style=color:#960050;background-color:#1e0010>?</span>:<span style=color:#ae81ff>2</span>f<span style=color:#f92672>|</span><span style=color:#ae81ff>5</span>c))\<span style=color:#f92672>.</span>(<span style=color:#960050;background-color:#1e0010>?</span>:<span style=color:#f92672>%</span><span style=color:#ae81ff>0</span>[<span style=color:#ae81ff>0</span><span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>])<span style=color:#960050;background-color:#1e0010>?</span>
</span></span></code></pre></div><p>The input marker <code>##!=&lt;</code> takes an identifier as a parameter and associates the output of the preceding block with the identifier. No output is produced when using the input <code>##!=&lt;</code> marker. To concatenate the output of a previously stored block, the appropriate identifier must be passed to the output marker <code>##!=></code> as an argument. Stored blocks remain in storage until the end of the program and are available globally. Any input stored previously can be retrieved at any nesting level. Both of the following examples produce the output <code>ab</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>##!&gt; assemble</span>
</span></span><span style=display:flex><span>  ab
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!=&lt; myinput</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!&gt; assemble</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>##!=&gt; myinput</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!&lt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##!&lt;</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>##!&gt; assemble</span>
</span></span><span style=display:flex><span>  ab
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!=&lt; myinput</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##!&lt;</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##!&gt; assemble</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!=&gt; myinput</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##!&lt;</span>
</span></span></code></pre></div><p>Rule 930100 requires the following concatenation of rules: <code>&lt;slash rules>&lt;dot rules>&lt;slash rules></code>, where <code>slash rules</code> is concatenated twice. The following example produces this sequence by storing the expression for slashes with the identifier <code>slashes</code>, thus avoiding duplication:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>##!&gt; assemble</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>##! slash patterns</span>
</span></span><span style=display:flex><span>  \x5c
</span></span><span style=display:flex><span>  <span style=color:#75715e>##! URI encoded</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>%</span><span style=color:#ae81ff>2</span>f
</span></span><span style=display:flex><span>  <span style=color:#f92672>%</span><span style=color:#ae81ff>5</span>c
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!=&lt; slashes</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!=&gt; slashes</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>##! dot patterns</span>
</span></span><span style=display:flex><span>  \<span style=color:#f92672>.</span>
</span></span><span style=display:flex><span>  \<span style=color:#f92672>.%</span><span style=color:#ae81ff>00</span>
</span></span><span style=display:flex><span>  \<span style=color:#f92672>.%</span><span style=color:#ae81ff>01</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!=&gt;</span>
</span></span><span style=display:flex><span>  <span style=color:#75715e>##!=&gt; slashes</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##!&lt;</span>
</span></span></code></pre></div><h2 id=definition-processor>Definition processor</h2><p>Processor name: <code>define</code></p><h3 id=arguments-2>Arguments</h3><ul><li>Identifier (required): The name of the definition that will be processed by this processor</li><li>Replacement (required): The string that replaces the definition identified by <code>identifier</code></li></ul><h3 id=output-2>Output</h3><p>One line per line of input, with all definition strings replaced with the specified replacement.</p><h3 id=description-2>Description</h3><p>The definition processor makes it easy to add recurring strings to expressions. This helps reduce maintenance when a definition needs to be updated. It also improves readability as definition strings provide readable and bounded information, where otherwise a regular expression must be read and boundaries must be identified.</p><p>The format of definition strings is as follows:</p><pre tabindex=0><code>{{identifier}}
</code></pre><p>The definition string starts with two opening braces, is followed by an identifier, and ends with two closing braces. The identifier format must satisfy the following regular expression:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>[a<span style=color:#f92672>-</span>z<span style=color:#f92672>-</span>A<span style=color:#f92672>-</span>Z\d_<span style=color:#f92672>-</span>]<span style=color:#f92672>+</span>
</span></span></code></pre></div><p>An identifier must have at least one character and consist only of upper and lowercase letters a through z, digits 0 through 9, and underscore or dash.</p><p>The following example shows how to use the definition processor:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>##!&gt; define slashes [/\x5c]</span>
</span></span><span style=display:flex><span>regex <span style=color:#66d9ef>with</span> {{slashes}}
</span></span></code></pre></div><p>This would result in the output <code>regex with [/\x5c]</code>.</p><h2 id=include-processor>Include processor</h2><p>Processor name: <code>include</code></p><h3 id=arguments-3>Arguments</h3><ul><li>Include file name (required): The name of the file to include, without suffix</li></ul><h3 id=output-3>Output</h3><p>The exact contents of the included file, including processor directives. The prefix and suffix markers are not allowed in included files.</p><h3 id=description-3>Description</h3><p>The include processor reduces repetition across assembly files. Repeated blocks can be put into a file in the <code>include</code> directory and then be included with the <code>include</code> processor comment. Include files are normal assembly files, hence include files can also contain further include directives. The only restriction is that included files must not contain the prefix of suffix markers. This is a technical limitation in the <a href=/documentation/development/crs_toolchain/>crs-toolchain</a>.</p><p>The contents of an include file could, for example, be the alternation of accepted HTTP methods:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>POST
</span></span><span style=display:flex><span>GET
</span></span><span style=display:flex><span>HEAD
</span></span></code></pre></div><p>This could be included into an assembly file for a rule that adds an additional method:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>##!&gt; include http-headers</span>
</span></span><span style=display:flex><span>OPTIONS
</span></span></code></pre></div><p>The resulting regular expression would be <code>(?:POS|GE)T|HEAD|OPTIONS</code>.</p><p>Additionally, definition directives of include files are available to the including file. This means that include files can be used as libraries of expressions. For example, an include file called <code>lib.ra</code> could contain the following definitions:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>##!&gt; define quotes [&#39;&#34;`]</span>
</span></span><span style=display:flex><span><span style=color:#75715e>##!&gt; define opt-lazy-wspace \s*?</span>
</span></span></code></pre></div><p>These definitions could then be used in an including file as follows:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>##!&gt; include lib</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>it{{quotes}}s{{opt<span style=color:#f92672>-</span>lazy<span style=color:#f92672>-</span>wspace}}possible
</span></span></code></pre></div><p>Note that the include processor does not have a body, thus the end marker is optional.</p><h2 id=include-except-processor>Include-Except processor</h2><p>Processor name: <code>include-except</code></p><h3 id=arguments-4>Arguments</h3><ul><li>Include file name (required): The name of the file to include, without suffix</li><li>Exclude file name (required): The name of the file to consult for exclusions, without suffix</li></ul><h3 id=output-4>Output</h3><p>The contents of the included file as per the include processor, but with all matching lines from the exclude file removed.</p><h3 id=description-4>Description</h3><p>The include-except processor further improves reusability of include files by removing exact line matches found in the exclude file from the result. A use case for this scenario is remote command execution where it is desirable to have a single list of commands but where certain commands should be excluded from some rules to avoid false positives. Consider the following list of command words:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>cat
</span></span><span style=display:flex><span>wget
</span></span><span style=display:flex><span>who
</span></span><span style=display:flex><span>zless
</span></span></code></pre></div><p>This list may be usable at paranoia level 2 or 3 but the words <code>cat</code> and <code>who</code> would produce too many false positives at paranoia level 1. To work around this issue, the following exclude file can be used:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span>cat
</span></span><span style=display:flex><span>who
</span></span></code></pre></div><p>The regular expression for a rule at paranoia level 1 would then be generated by the following:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=display:flex><span><span style=color:#75715e>##!&gt; include-except command-list pl1-exclude-list</span>
</span></span></code></pre></div><p>Note that the include-exclude processor does not have a body, thus the end marker is optional.</p><footer class=footline></footer></main></div><div id=navigation><a class="nav nav-prev" href=/documentation/development/crs_toolchain/ title=crs-toolchain><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/documentation/development/rule_writing/ title="Writing Rules"><i class="fa fa-chevron-right"></i></a></div></div><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/documentation/js/clipboard.min.js?1685994226></script>
<script src=/documentation/js/perfect-scrollbar.min.js?1685994226></script>
<script src=/documentation/js/perfect-scrollbar.jquery.min.js?1685994226></script>
<script src=/documentation/js/jquery.svg.pan.zoom.js?1685994226></script>
<script src=/documentation/js/featherlight.min.js?1685994226></script>
<script src=/documentation/js/modernizr.custom-3.6.0.js?1685994226></script>
<script src=/documentation/js/mermaid.min.js?1685994226></script>
<script>typeof mermaid!="undefined"&&mermaid.mermaidAPI.initialize(Object.assign({securityLevel:"antiscript"},JSON.parse('{ "startOnLoad": true }'),{startOnLoad:!1}))</script><script src=/documentation/js/relearn.js?1685994226></script>
<script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="https://piwik.netnea.com/matomo/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","4"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script><img referrerpolicy=no-referrer-when-downgrade src="https://piwik.netnea.com/matomo/matomo.php?idsite=4&rec=1" style=border:0 alt></body></html>