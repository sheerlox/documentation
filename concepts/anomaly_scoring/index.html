<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.97.3"><meta name=description content="CoreRuleSet Documentation"><meta name=author content="CoreRuleSet"><link rel=icon href=/documentation/images/favicon.png type=image/png><title>Anomaly Scoring :: Core Rule Set Documentation</title><link href=/documentation/css/nucleus.css?1694520495 rel=stylesheet><link href=/documentation/css/fontawesome-all.min.css?1694520495 rel=stylesheet><link href=/documentation/css/featherlight.min.css?1694520495 rel=stylesheet><link href=/documentation/css/perfect-scrollbar.min.css?1694520495 rel=stylesheet><link href=/documentation/css/auto-complete.css?1694520495 rel=stylesheet><link href=/documentation/css/theme.css?1694520495 rel=stylesheet><link href=/documentation/css/theme-blue.css?1694520495 rel=stylesheet><link href=/documentation/css/variant.css?1694520495 rel=stylesheet><link href=/documentation/css/print.css?1694520495 rel=stylesheet media=print><script src=/documentation/js/jquery.min.js?1694520495></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/documentation/concepts/anomaly_scoring/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=https://coreruleset.github.io/documentation/><img src=https://coreruleset.github.io/documentation//images/logo.png></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script src=/documentation/js/lunr.min.js?1694520495></script>
<script src=/documentation/js/auto-complete.js?1694520495></script>
<script>var index_url="/documentation/index.json",root_url="/",baseUri=root_url.replace(/\/$/,'')</script><script src=/documentation/js/search.js?1694520495></script></div><div id=homelinks><ul><li><a class=padding href=/documentation/><i class="fas fa-home"></i> Home</a></li></ul></div><div class=highlightable><ul class=topics><li data-nav-id=/documentation/deployment/ title="Getting CRS" class=dd-item><a href=/documentation/deployment/><b>1. </b>Getting CRS<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/deployment/engine_integration_options/ title="Engine and Integration Options" class=dd-item><a href=/documentation/deployment/engine_integration_options/>Engine and Integration Options<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/deployment/quick_start/ title="Quick Start Guide" class=dd-item><a href=/documentation/deployment/quick_start/>Quick Start Guide<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/deployment/install/ title="Extended Install" class=dd-item><a href=/documentation/deployment/install/>Extended Install<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/concepts/ title="How CRS Works" class="dd-item parent"><a href=/documentation/concepts/><b>2. </b>How CRS Works<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/concepts/anomaly_scoring/ title="Anomaly Scoring" class="dd-item active"><a href=/documentation/concepts/anomaly_scoring/>Anomaly Scoring<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/concepts/paranoia_levels/ title="Paranoia Levels" class=dd-item><a href=/documentation/concepts/paranoia_levels/>Paranoia Levels<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/concepts/false_positives_tuning/ title="False Positives and Tuning" class=dd-item><a href=/documentation/concepts/false_positives_tuning/>False Positives and Tuning<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/concepts/plugins/ title="Plugin Mechanism" class=dd-item><a href=/documentation/concepts/plugins/>Plugin Mechanism<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/concepts/sampling_mode/ title="Sampling Mode" class=dd-item><a href=/documentation/concepts/sampling_mode/>Sampling Mode<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/operation/ title=Operation class=dd-item><a href=/documentation/operation/><b>3. </b>Operation<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/operation/known_issues/ title="Known Issues" class=dd-item><a href=/documentation/operation/known_issues/>Known Issues<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/operation/containers/ title="Using Containers" class=dd-item><a href=/documentation/operation/containers/>Using Containers<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/operation/kubernetes_ingress/ title="Kubernetes Ingress Controllers" class=dd-item><a href=/documentation/operation/kubernetes_ingress/>Kubernetes Ingress Controllers<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/operation/log_handling/ title="Log Handling" class=dd-item><a href=/documentation/operation/log_handling/>Log Handling<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/rules/ title=Rules class=dd-item><a href=/documentation/rules/><b>4. </b>Rules<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/rules/ruleid/ title="Rule IDs" class=dd-item><a href=/documentation/rules/ruleid/>Rule IDs<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/rules/ title=Rules class=dd-item><a href=/documentation/rules/rules/>Rules<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/creating/ title=Making class=dd-item><a href=/documentation/rules/creating/>Making<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/metadata/ title=Metadata class=dd-item><a href=/documentation/rules/metadata/>Metadata<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/development/ title=Development class=dd-item><a href=/documentation/development/><b>5. </b>Development<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/development/contribution_guidelines/ title="Contribution Guidelines" class=dd-item><a href=/documentation/development/contribution_guidelines/>Contribution Guidelines<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/crs_toolchain/ title=crs-toolchain class=dd-item><a href=/documentation/development/crs_toolchain/>crs-toolchain<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/regex_assembly/ title="Assembling Regular Expressions" class=dd-item><a href=/documentation/development/regex_assembly/>Assembling Regular Expressions<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/rule_writing/ title="Writing Rules" class=dd-item><a href=/documentation/development/rule_writing/>Writing Rules<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/useful_tools/ title="Useful Tools" class=dd-item><a href=/documentation/development/useful_tools/>Useful Tools<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/testing/ title="Testing the Rule Set" class=dd-item><a href=/documentation/development/testing/>Testing the Rule Set<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/plugin_writing/ title="Writing Plugins" class=dd-item><a href=/documentation/development/plugin_writing/>Writing Plugins<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/sandbox/ title="Using the CRS Sandbox" class=dd-item><a href=/documentation/development/sandbox/>Using the CRS Sandbox<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/resources/ title="Additional Resources" class=dd-item><a href=/documentation/resources/><b>6. </b>Additional Resources<i class="fas fa-check read-icon"></i></a><ul></ul></li><li data-nav-id=/documentation/miscellaneous/ title=Miscellaneous class=dd-item><a href=/documentation/miscellaneous/><b>7. </b>Miscellaneous<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/miscellaneous/self_contained_mode/ title="Self-Contained Mode" class=dd-item><a href=/documentation/miscellaneous/self_contained_mode/>Self-Contained Mode<i class="fas fa-check read-icon"></i></a></li></ul></li></ul><div id=shortcuts><div class=nav-title>More</div><ul><li><a class=padding href=https://coreruleset.org/><i class="fas fa-bookmark"></i> Core Rule Set Home</a></li><li><a class=padding href=https://github.com/coreruleset/coreruleset><i class="fab fa-github"></i> Core Rule Set GitHub</a></li></ul></div><div id=prefooter><hr><ul><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li></ul></div><div id=footer><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></nav><div id=body><div id=overlay></div><div class="padding highlightable"><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/coreruleset/documentation/blob/main/content/concepts/anomaly_scoring.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Anomaly Scoring</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#overview-of-anomaly-scoring>Overview of Anomaly Scoring</a></li><li><a href=#how-anomaly-scoring-mode-works>How Anomaly Scoring Mode Works</a><ul><li><a href=#summary-of-anomaly-scoring-mode>Summary of Anomaly Scoring Mode</a></li><li><a href=#the-anomaly-scoring-mechanism-in-action>The Anomaly Scoring Mechanism In Action</a></li></ul></li><li><a href=#configuring-anomaly-scoring-mode>Configuring Anomaly Scoring Mode</a><ul><li><a href=#anomaly-score-thresholds>Anomaly Score Thresholds</a></li><li><a href=#severity-levels>Severity Levels</a></li><li><a href=#early-blocking>Early Blocking</a></li></ul></li></ul></nav></div></div></div><div id=head-tags></div><main id=body-inner><h1>Anomaly Scoring</h1><blockquote><p>The Core Rule Set 3 is designed as an anomaly scoring rule set. This page explains what anomaly scoring is and how to use it.</p></blockquote><h2 id=overview-of-anomaly-scoring>Overview of Anomaly Scoring</h2><p>Anomaly scoring, also known as &ldquo;collaborative detection&rdquo;, is a scoring mechanism used in the Core Rule Set. It assigns a numeric score to HTTP transactions (requests and responses), representing how &lsquo;anomalous&rsquo; they appear to be. Anomaly scores can then be used to make blocking decisions. The default CRS blocking policy, for example, is to block any transaction that meets or exceeds a defined anomaly score threshold.</p><h2 id=how-anomaly-scoring-mode-works>How Anomaly Scoring Mode Works</h2><p>Anomaly scoring mode combines the concepts of <em>collaborative detection</em> and <em>delayed blocking</em>. The key idea to understand is that <strong>the inspection/detection rule logic is decoupled from the blocking functionality</strong>.</p><p>Individual rules designed to detect specific types of attacks and malicious behavior are executed. If a rule matches, no immediate disruptive action is taken (e.g. the transaction is not blocked). Instead, the matched rule contributes to a transactional <em>anomaly score</em>, which acts as a running total. The rules just handle detection, adding to the anomaly score if they match. In addition, an individual matched rule will typically log a record of the match for later reference, including the ID of the matched rule, the data that caused the match, and the URI that was being requested.</p><p>Once all of the rules that inspect <em>request</em> data have been executed, <em>blocking evaluation</em> takes place. If the anomaly score is greater than or equal to the inbound anomaly score threshold then the transaction is <em>denied</em>. Transactions that are not denied continue on their journey.</p><p><img src="as_inbound_no_fonts.svg?height=36em" alt="Diagram showing an example where the inbound anomaly score threshold is set to 5. A first example request accumulates an anomaly score of 2 and is allowed to pass at the blocking evaluation step. A second example request accumulates an anomaly score of 7 and is denied at the blocking evaluation step."></p><p>Continuing on, once all of the rules that inspect <em>response</em> data have been executed, a second round of blocking evaluation takes place. If the <em>outbound</em> anomaly score is greater than or equal to the outbound anomaly score threshold, then the response is <em>not returned</em> to the user. (Note that in this case, the request <em>is</em> fully handled by the backend or application; only the response is stopped.)</p><div class="notices info"><div class=label>Info</div><p>Having separate inbound and outbound anomaly scores and thresholds allows for request data and response data to be inspected and scored independently.</p></div><h3 id=summary-of-anomaly-scoring-mode>Summary of Anomaly Scoring Mode</h3><p>To summarize, anomaly scoring mode in the CRS works like so:</p><ol><li>Execute all <em>request</em> rules</li><li>Make a blocking decision using the <em>inbound</em> anomaly score threshold</li><li>Execute all <em>response</em> rules</li><li>Make a blocking decision using the <em>outbound</em> anomaly score threshold</li></ol><h3 id=the-anomaly-scoring-mechanism-in-action>The Anomaly Scoring Mechanism In Action</h3><p>As described, individual rules are only responsible for detection and inspection: they do not block or deny transactions. If a rule matches then it increments the anomaly score. This is done using ModSecurity&rsquo;s <code>setvar</code> action.</p><p>Below is an example of a detection rule which matches when a request has a <code>Content-Length</code> header field containing something other than digits. Notice the final line of the rule: it makes use of the <code>setvar</code> action, which will increment the anomaly score if the rule matches:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span>SecRule REQUEST_HEADERS:Content-Length <span style=color:#e6db74>&#34;!@rx ^\d+$&#34;</span> \
</span></span><span style=display:flex><span>    <span style=color:#960050;background-color:#1e0010>&#34;</span>id:920160,\
</span></span><span style=display:flex><span>    phase:1,\
</span></span><span style=display:flex><span>    block,\
</span></span><span style=display:flex><span>    t:none,\
</span></span><span style=display:flex><span>    msg:&#39;Content-Length HTTP header is not numeric&#39;,\
</span></span><span style=display:flex><span>    logdata:&#39;%{MATCHED_VAR}&#39;,\
</span></span><span style=display:flex><span>    tag:&#39;application-multi&#39;,\
</span></span><span style=display:flex><span>    tag:&#39;language-multi&#39;,\
</span></span><span style=display:flex><span>    tag:&#39;platform-multi&#39;,\
</span></span><span style=display:flex><span>    tag:&#39;attack-protocol&#39;,\
</span></span><span style=display:flex><span>    tag:&#39;paranoia-level/1&#39;,\
</span></span><span style=display:flex><span>    tag:&#39;OWASP_CRS&#39;,\
</span></span><span style=display:flex><span>    tag:&#39;capec/1000/210/272&#39;,\
</span></span><span style=display:flex><span>    ver:&#39;OWASP_CRS/3.4.0-dev&#39;,\
</span></span><span style=display:flex><span>    severity:&#39;CRITICAL&#39;,\
</span></span><span style=display:flex><span>    setvar:&#39;tx.anomaly_score_pl1=+%{tx.critical_anomaly_score}&#39;<span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span></code></pre></div><div class="notices info"><div class=label>Info</div><p>Notice that the anomaly score variable name has the suffix <code>pl1</code>. Internally, CRS keeps track of anomaly scores on a <em>per</em> <a href=/documentation/concepts/paranoia_levels/ title="Page describing paranoia levels."><em>paranoia level</em></a> basis. The individual paranoia level anomaly scores are added together before each round of blocking evaluation takes place, allowing the total combined inbound or outbound score to be compared to the relevant anomaly score threshold.</p><p>Tracking the anomaly score per paranoia level allows for clever scoring mechanisms to be employed, such as the <a href=/documentation/concepts/paranoia_levels/#moving-to-a-higher-paranoia-level title="Section describing the executing paranoia level feature.">executing paranoia level</a> feature.</p></div><p>The rules files <code>REQUEST-949-BLOCKING-EVALUATION.conf</code> and <code>RESPONSE-959-BLOCKING-EVALUATION.conf</code> are responsible for executing the inbound (request) and outbound (response) rounds of blocking evaluation, respectively. The rules in these files calculate the total inbound or outbound transactional anomaly score and then make a blocking decision, by comparing the result to the defined threshold and taking blocking action if required.</p><h2 id=configuring-anomaly-scoring-mode>Configuring Anomaly Scoring Mode</h2><p>The following settings can be configured when using anomaly scoring mode:</p><ul><li>Anomaly score thresholds</li><li>Severity levels</li><li>Early blocking</li></ul><p>If using a native Core Rule Set installation on a web application firewall, these settings are defined in the file <code>crs-setup.conf</code>. If running CRS where it has been integrated into a commercial product or CDN then support varies. Some vendors expose these settings in the GUI while other vendors require custom rules to be written which set the necessary variables. Unfortunately, there are also vendors that don&rsquo;t allow these settings to be configured at all.</p><h3 id=anomaly-score-thresholds>Anomaly Score Thresholds</h3><p>An anomaly score threshold is the cumulative anomaly score at which an inbound request or an outbound response will be blocked.</p><p>Most detected inbound threats carry an anomaly score of 5 (by default), while smaller violations, e.g. protocol and standards violations, carry lower scores. An anomaly score threshold of 7, for example, would require multiple rule matches in order to trigger a block (e.g. one &ldquo;critical&rdquo; rule scoring 5 plus a lesser-scoring rule, in order to reach the threshold of 7). An anomaly score threshold of 10 would require at least two &ldquo;critical&rdquo; rules to match, or a combination of many lesser-scoring rules. <strong>Increasing the anomaly score thresholds makes the CRS less sensitive</strong> and hence less likely to block transactions.</p><p>Rule coverage should be taken into account when setting anomaly score thresholds. Different CRS rule categories feature different numbers of rules. SQL injection, for example, is covered by more than 50 rules. As a result, a real world SQLi attack can easily gain an anomaly score of 15, 20, or even more. On the other hand, a rare protocol attack might only be covered by a single, specific rule. If such an attack only causes the one specific rule to match then it will only gain an anomaly score of 5. If the inbound anomaly score threshold is set to anything higher than 5 then attacks like the one described will not be stopped. <strong>As such, a CRS installation should aim for an inbound anomaly score threshold of 5.</strong></p><div class="notices warning"><div class=label>Warning</div><p>Increasing the anomaly score thresholds may allow some attacks to bypass the CRS rules.</p></div><div class="notices info"><div class=label>Info</div><p>An outbound anomaly score threshold of 4 (the default) will block a transaction if any single response rule matches.</p></div><div class="notices tip"><div class=label>Tip</div><p>A common practice when working with a <strong>new</strong> CRS deployment is to start in blocking mode from the very beginning with <em>very high anomaly score thresholds</em> (even as high as 10000). The thresholds can be gradually lowered over time as an iterative process.</p><p>This tuning method was developed and advocated by Christian Folini, who documented it in detail, along with examples, in a popular tutorial titled <a href=https://www.netnea.com/cms/apache-tutorial-8_handling-false-positives-modsecurity-core-rule-set/>Handling False Positives with the OWASP ModSecurity Core Rule Set</a>.</p></div><p>CRS uses two anomaly score thresholds, which can be defined using the variables listed below:</p><table><thead><tr><th>Threshold</th><th>Variable</th></tr></thead><tbody><tr><td>Inbound anomaly score threshold</td><td><code>tx.inbound_anomaly_score_threshold</code></td></tr><tr><td>Outbound anomaly score threshold</td><td><code>tx.outbound_anomaly_score_threshold</code></td></tr></tbody></table><p>A simple way to set these thresholds is to uncomment and use rule 900110:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span>SecAction \
</span></span><span style=display:flex><span> <span style=color:#960050;background-color:#1e0010>&#34;</span>id:900110,\
</span></span><span style=display:flex><span>  phase:1,\
</span></span><span style=display:flex><span>  nolog,\
</span></span><span style=display:flex><span>  pass,\
</span></span><span style=display:flex><span>  t:none,\
</span></span><span style=display:flex><span>  setvar:tx.inbound_anomaly_score_threshold=5,\
</span></span><span style=display:flex><span>  setvar:tx.outbound_anomaly_score_threshold=4<span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span></code></pre></div><h3 id=severity-levels>Severity Levels</h3><p>Each CRS rule has an associated <em>severity level</em>. Different severity levels have different anomaly scores associated with them. This means that different rules can increment the anomaly score by different amounts if the rules match.</p><p>The four severity levels and their <em>default</em> anomaly scores are:</p><table><thead><tr><th>Severity Level</th><th>Default Anomaly Score</th></tr></thead><tbody><tr><td><strong>CRITICAL</strong></td><td>5</td></tr><tr><td><strong>ERROR</strong></td><td>4</td></tr><tr><td><strong>WARNING</strong></td><td>3</td></tr><tr><td><strong>NOTICE</strong></td><td>2</td></tr></tbody></table><p>For example, by default, a single matching <code>CRITICAL</code> rule would increase the anomaly score by 5, while a single matching <code>WARNING</code> rule would increase the anomaly score by 3.</p><p>The default anomaly scores are rarely ever changed. It is possible, however, to set custom anomaly scores for severity levels. To do so, uncomment rule 900100 and set the anomaly scores as desired:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span>SecAction \
</span></span><span style=display:flex><span> <span style=color:#960050;background-color:#1e0010>&#34;</span>id:900100,\
</span></span><span style=display:flex><span>  phase:1,\
</span></span><span style=display:flex><span>  nolog,\
</span></span><span style=display:flex><span>  pass,\
</span></span><span style=display:flex><span>  t:none,\
</span></span><span style=display:flex><span>  setvar:tx.critical_anomaly_score=5,\
</span></span><span style=display:flex><span>  setvar:tx.error_anomaly_score=4,\
</span></span><span style=display:flex><span>  setvar:tx.warning_anomaly_score=3,\
</span></span><span style=display:flex><span>  setvar:tx.notice_anomaly_score=2<span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span></code></pre></div><div class="notices info"><div class=label>Info</div><p>The CRS makes use of a ModSecurity feature called <em>macro expansion</em> to propagate the value of the severity level anomaly scores throughout the entire rule set.</p></div><h3 id=early-blocking>Early Blocking</h3><p>Early blocking is an optional setting which can be enabled to allow blocking decisions to be made earlier than usual.</p><p>As summarized previously, anomaly scoring mode works like so:</p><ol><li>Execute all <em>request</em> rules</li><li>Make a <strong>blocking decision</strong> using the <em>inbound</em> anomaly score threshold</li><li>Execute all <em>response</em> rules</li><li>Make a <strong>blocking decision</strong> using the <em>outbound</em> anomaly score threshold</li></ol><p>The early blocking option takes advantage of the fact that the request and response rules are actually split across different <em>phases</em>. A more detailed overview of anomaly scoring mode looks like so:</p><ol><li>Execute all phase 1 <em>(request header)</em> rules</li><li>Execute all phase 2 <em>(request body)</em> rules</li><li>Make a <strong>blocking decision</strong> using the <em>inbound</em> anomaly score threshold</li><li>Execute all phase 3 <em>(response header)</em> rules</li><li>Execute all phase 4 <em>(response body)</em> rules</li><li>Make a <strong>blocking decision</strong> using the <em>outbound</em> anomaly score threshold</li></ol><p>More data from a transaction becomes available for inspection in each subsequent processing phase. In phase 1 the request headers are available for inspection. Detection rules that are only concerned with request headers are executed here. In phase 2 the request body also becomes available for inspection. Rules that need to inspect the request body, perhaps in addition to request headers, are executed here.</p><p>If a transaction&rsquo;s anomaly score <em>already</em> meets or exceeds the inbound anomaly score threshold by the end of phase 1 (due to causing phase 1 rules to match) then, in theory, the phase 2 rules don&rsquo;t need to be executed. This saves the time and resources it would take to process the detection rules in phase 2 and also protects the server from being attacked when handling the body of the request. The majority of CRS rules take place in phase 2, which is also where the request body inspection rules are located. When dealing with large request bodies, it may be worthwhile to avoid executing the phase 2 rules in this way. The same logic applies to blocking <em>responses</em> that have already met the <em>outbound</em> anomaly score threshold in phase 3, <em>before</em> reaching phase 4. This saves the time and resources required to execute the phase 4 rules, which inspect the response body.</p><p>Early blocking makes this possible by inserting <strong>two additional rounds of blocking evaluation</strong>: one after the phase 1 detection rules have finished executing, and another after the phase 3 detection rules:</p><ol><li>Execute all phase 1 <em>(request header)</em> rules</li><li>Make an <strong>early blocking decision</strong> using the <em>inbound</em> anomaly score threshold</li><li>Execute all phase 2 <em>(request body)</em> rules</li><li>Make a <strong>blocking decision</strong> using the <em>inbound</em> anomaly score threshold</li><li>Execute all phase 3 <em>(response header)</em> rules</li><li>Make an <strong>early blocking decision</strong> using the <em>outbound</em> anomaly score threshold</li><li>Execute all phase 4 <em>(response body)</em> rules</li><li>Make a <strong>blocking decision</strong> using the <em>outbound</em> anomaly score threshold</li></ol><div class="notices info"><div class=label>Info</div><p>More information about processing phases can be found in the <a href=https://github.com/SpiderLabs/ModSecurity/wiki/Reference-Manual-(v2.x)#processing-phases>processing phases section</a> of the ModSecurity Reference Manual.</p></div><div class="notices warning"><div class=label>Warning</div><p>The early blocking option has a major drawback to be aware of: <strong>it can cause potential alerts to be hidden</strong>.</p><p>If a transaction is blocked early then its body is not inspected. For example, if a transaction is blocked early at the end of phase 1 (the request headers phase) then the body of the request is never inspected. If the early blocking option is <em>not</em> enabled, it&rsquo;s possible that such a transaction would proceed to cause phase 2 rules to match. Early blocking hides these potential alerts. The same applies to responses that trigger an early block: it&rsquo;s possible that some phase 4 rules would match if early blocking were not enabled.</p><p>Using the early blocking option results in having less information to work with, due to fewer rules being executed. This may mean that the full picture is not present in log files when looking back at attacks and malicious traffic. It can also be a problem when dealing with false positives: tuning away a false positive in phase 1 will allow the same request to proceed to the next phase the next time it&rsquo;s issued (instead of being blocked at the end of phase 1). The problem is that now, with the request making it past phase 1, more, previously &ldquo;hidden&rdquo; false positives may appear in phase 2.</p></div><div class="notices warning"><div class=label>Warning</div><p>If early blocking is not enabled, there&rsquo;s a chance that the web server will interfere with the handling of a request between phases 1 and 2. Take the example where the Apache web server issues a redirect to a new location. With a request that violates CRS rules in phase 1, this may mean that the request has a higher anomaly score than the defined threshold but it gets redirected away before blocking evaluation happens.</p></div><h4 id=enabling-the-early-blocking-option>Enabling the Early Blocking Option</h4><p>If using a native Core Rule Set installation on a web application firewall, the early blocking option can be enabled in the file <code>crs-setup.conf</code>. This is done by uncommenting rule 900120, which sets the variable <code>tx.blocking_early</code> to 1 in order to enable early blocking. CRS otherwise gives this variable a default value of 0, meaning that early blocking is disabled by default.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span>SecAction \
</span></span><span style=display:flex><span>  <span style=color:#960050;background-color:#1e0010>&#34;</span>id:900120,\
</span></span><span style=display:flex><span>  phase:1,\
</span></span><span style=display:flex><span>  nolog,\
</span></span><span style=display:flex><span>  pass,\
</span></span><span style=display:flex><span>  t:none,\
</span></span><span style=display:flex><span>  setvar:tx.blocking_early=1<span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span></code></pre></div><p>If running CRS where it has been integrated into a commercial product or CDN then support for the early blocking option varies. Some vendors may allow it to be enabled through the GUI, through a custom rule, or they might not allow it to be enabled at all.</p><footer class=footline></footer></main></div><div id=navigation><a class="nav nav-prev" href=/documentation/concepts/ title="How CRS Works"><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/documentation/concepts/paranoia_levels/ title="Paranoia Levels"><i class="fa fa-chevron-right"></i></a></div></div><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/documentation/js/clipboard.min.js?1694520495></script>
<script src=/documentation/js/perfect-scrollbar.min.js?1694520495></script>
<script src=/documentation/js/perfect-scrollbar.jquery.min.js?1694520495></script>
<script src=/documentation/js/jquery.svg.pan.zoom.js?1694520495></script>
<script src=/documentation/js/featherlight.min.js?1694520495></script>
<script src=/documentation/js/modernizr.custom-3.6.0.js?1694520495></script>
<script src=/documentation/js/mermaid.min.js?1694520495></script>
<script>typeof mermaid!="undefined"&&mermaid.mermaidAPI.initialize(Object.assign({securityLevel:"antiscript"},JSON.parse('{ "startOnLoad": true }'),{startOnLoad:!1}))</script><script src=/documentation/js/relearn.js?1694520495></script>
<script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="https://piwik.netnea.com/matomo/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","4"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script><img referrerpolicy=no-referrer-when-downgrade src="https://piwik.netnea.com/matomo/matomo.php?idsite=4&rec=1" style=border:0 alt></body></html>