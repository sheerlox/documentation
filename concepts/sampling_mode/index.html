<!doctype html><html lang=en class="js csstransforms3d"><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=generator content="Hugo 0.97.3"><meta name=description content="CoreRuleSet Documentation"><meta name=author content="CoreRuleSet"><link rel=icon href=/documentation/images/favicon.png type=image/png><title>Sampling Mode :: Core Rule Set Documentation</title><link href=/documentation/css/nucleus.css?1681766460 rel=stylesheet><link href=/documentation/css/fontawesome-all.min.css?1681766460 rel=stylesheet><link href=/documentation/css/featherlight.min.css?1681766460 rel=stylesheet><link href=/documentation/css/perfect-scrollbar.min.css?1681766460 rel=stylesheet><link href=/documentation/css/auto-complete.css?1681766460 rel=stylesheet><link href=/documentation/css/theme.css?1681766460 rel=stylesheet><link href=/documentation/css/theme-blue.css?1681766460 rel=stylesheet><link href=/documentation/css/variant.css?1681766460 rel=stylesheet><link href=/documentation/css/print.css?1681766460 rel=stylesheet media=print><script src=/documentation/js/jquery.min.js?1681766460></script><style>:root #header+#content>#left>#rlblock_left{display:none!important}</style></head><body data-url=/documentation/concepts/sampling_mode/><nav id=sidebar class=showVisitedLinks><div id=header-wrapper><div id=header><a id=logo href=https://coreruleset.github.io/documentation/><img src=https://coreruleset.github.io/documentation//images/logo.png></a></div><div class=searchbox><label for=search-by><i class="fas fa-search"></i></label>
<input data-search-input id=search-by type=search placeholder=Search...>
<span data-search-clear><i class="fas fa-times"></i></span></div><script src=/documentation/js/lunr.min.js?1681766460></script>
<script src=/documentation/js/auto-complete.js?1681766460></script>
<script>var index_url="/documentation/index.json",root_url="/",baseUri=root_url.replace(/\/$/,'')</script><script src=/documentation/js/search.js?1681766460></script></div><div id=homelinks><ul><li><a class=padding href=/documentation/><i class="fas fa-home"></i> Home</a></li></ul></div><div class=highlightable><ul class=topics><li data-nav-id=/documentation/deployment/ title="Getting CRS" class=dd-item><a href=/documentation/deployment/><b>1. </b>Getting CRS<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/deployment/engine_integration_options/ title="Engine and Integration Options" class=dd-item><a href=/documentation/deployment/engine_integration_options/>Engine and Integration Options<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/deployment/quick_start/ title="Quick Start Guide" class=dd-item><a href=/documentation/deployment/quick_start/>Quick Start Guide<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/deployment/install/ title="Extended Install" class=dd-item><a href=/documentation/deployment/install/>Extended Install<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/concepts/ title="How CRS Works" class="dd-item parent"><a href=/documentation/concepts/><b>2. </b>How CRS Works<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/concepts/anomaly_scoring/ title="Anomaly Scoring" class=dd-item><a href=/documentation/concepts/anomaly_scoring/>Anomaly Scoring<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/concepts/paranoia_levels/ title="Paranoia Levels" class=dd-item><a href=/documentation/concepts/paranoia_levels/>Paranoia Levels<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/concepts/false_positives_tuning/ title="False Positives and Tuning" class=dd-item><a href=/documentation/concepts/false_positives_tuning/>False Positives and Tuning<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/concepts/plugins/ title="Plugin Mechanism" class=dd-item><a href=/documentation/concepts/plugins/>Plugin Mechanism<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/concepts/sampling_mode/ title="Sampling Mode" class="dd-item active"><a href=/documentation/concepts/sampling_mode/>Sampling Mode<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/operation/ title=Operation class=dd-item><a href=/documentation/operation/><b>3. </b>Operation<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/operation/known_issues/ title="Known Issues" class=dd-item><a href=/documentation/operation/known_issues/>Known Issues<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/operation/containers/ title="Using Containers" class=dd-item><a href=/documentation/operation/containers/>Using Containers<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/operation/kubernetes_ingress/ title="Kubernetes Ingress Controllers" class=dd-item><a href=/documentation/operation/kubernetes_ingress/>Kubernetes Ingress Controllers<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/operation/log_handling/ title="Log Handling" class=dd-item><a href=/documentation/operation/log_handling/>Log Handling<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/rules/ title=Rules class=dd-item><a href=/documentation/rules/><b>4. </b>Rules<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/rules/ruleid/ title="Rule IDs" class=dd-item><a href=/documentation/rules/ruleid/>Rule IDs<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/rules/ title=Rules class=dd-item><a href=/documentation/rules/rules/>Rules<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/creating/ title=Making class=dd-item><a href=/documentation/rules/creating/>Making<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/rules/metadata/ title=Metadata class=dd-item><a href=/documentation/rules/metadata/>Metadata<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/development/ title=Development class=dd-item><a href=/documentation/development/><b>5. </b>Development<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/development/contribution_guidelines/ title="Contribution Guidelines" class=dd-item><a href=/documentation/development/contribution_guidelines/>Contribution Guidelines<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/crs_toolchain/ title=crs-toolchain class=dd-item><a href=/documentation/development/crs_toolchain/>crs-toolchain<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/regex_assembly/ title="Assembling Regular Expressions" class=dd-item><a href=/documentation/development/regex_assembly/>Assembling Regular Expressions<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/rule_writing/ title="Writing Rules" class=dd-item><a href=/documentation/development/rule_writing/>Writing Rules<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/useful_tools/ title="Useful Tools" class=dd-item><a href=/documentation/development/useful_tools/>Useful Tools<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/testing/ title="Testing the Rule Set" class=dd-item><a href=/documentation/development/testing/>Testing the Rule Set<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/plugin_writing/ title="Writing Plugins" class=dd-item><a href=/documentation/development/plugin_writing/>Writing Plugins<i class="fas fa-check read-icon"></i></a></li><li data-nav-id=/documentation/development/sandbox/ title="Using the CRS Sandbox" class=dd-item><a href=/documentation/development/sandbox/>Using the CRS Sandbox<i class="fas fa-check read-icon"></i></a></li></ul></li><li data-nav-id=/documentation/resources/ title="Additional Resources" class=dd-item><a href=/documentation/resources/><b>6. </b>Additional Resources<i class="fas fa-check read-icon"></i></a><ul></ul></li><li data-nav-id=/documentation/miscellaneous/ title=Miscellaneous class=dd-item><a href=/documentation/miscellaneous/><b>7. </b>Miscellaneous<i class="fas fa-check read-icon"></i></a><ul><li data-nav-id=/documentation/miscellaneous/self_contained_mode/ title="Self-Contained Mode" class=dd-item><a href=/documentation/miscellaneous/self_contained_mode/>Self-Contained Mode<i class="fas fa-check read-icon"></i></a></li></ul></li></ul><div id=shortcuts><div class=nav-title>More</div><ul><li><a class=padding href=https://coreruleset.org/><i class="fas fa-bookmark"></i> Core Rule Set Home</a></li><li><a class=padding href=https://github.com/coreruleset/coreruleset><i class="fab fa-github"></i> Core Rule Set GitHub</a></li></ul></div><div id=prefooter><hr><ul><li><a class=padding href=# data-clear-history-toggle><i class="fas fa-history fa-fw"></i> Clear History</a></li></ul></div><div id=footer><p>Built with <a href=https://github.com/McShelby/hugo-theme-relearn><i class="fas fa-heart"></i></a> by <a href=https://gohugo.io/>Hugo</a></p></div></div></nav><div id=body><div id=overlay></div><div class="padding highlightable"><div id=top-bar><div id=top-github-link><a class=github-link title="Edit this page" href=https://github.com/coreruleset/documentation/blob/main/content/concepts/sampling_mode.md target=blank><i class="fas fa-code-branch"></i>
<span id=top-github-link-text>Edit this page</span></a></div><div id=breadcrumbs><span id=sidebar-toggle-span><a href=# id=sidebar-toggle data-sidebar-toggle><i class="fas fa-bars"></i></a></span>
<span id=toc-menu><i class="fas fa-list-alt"></i></span>
<span class=links>Sampling Mode</span></div><div class=progress><div class=wrapper><nav id=TableOfContents><ul><li><a href=#introduction-to-sampling-mode>Introduction to Sampling Mode</a></li><li><a href=#applying-sampling-mode>Applying Sampling Mode</a><ul><li><a href=#disabling-sampling-mode-log-entries>Disabling Sampling Mode Log Entries</a></li></ul></li><li><a href=#rollback>Rollback</a></li><li><a href=#random-number-generation>Random Number Generation</a></li></ul></nav></div></div></div><div id=head-tags></div><main id=body-inner><h1>Sampling Mode</h1><blockquote><p>Sampling mode makes it possible to apply the Core Rule Set to a limited percentage of traffic only. This may be useful in certain scenarios when enabling CRS for the first time, as this page explains.</p></blockquote><h2 id=introduction-to-sampling-mode>Introduction to Sampling Mode</h2><p>The Core Rule Set&rsquo;s sampling mode mechanism was first introduced in version 3.0.0 in 2016. Although the feature has been available since then, it’s rarely used in practice, partly due to it being one of the lesser-known features of CRS.</p><p>When deploying ModSecurity and CRS in front of an existing web service for the first time, it&rsquo;s difficult to predict what&rsquo;s going to happen when CRS is turned on. A well-developed test environment can help, but it&rsquo;s rare to find an installation where real world traffic can be reproduced 1:1 on a test setup. As such, fully enabling ModSecurity and CRS can be something of a leap into the unknown, and potentially very disruptive. This scenario prompted the introduction of CRS 3&rsquo;s sampling mode.</p><p><strong>Sampling mode makes it possible to run CRS on a limited percentage of traffic.</strong> The remaining traffic will bypass the rule set. If it turns out that ModSecurity is extremely disruptive or if the rules are too resource heavy for the server, only a limited percentage of the total traffic can be negatively affected (for example, only 1%). This significantly reduces the potential impact and risk of enabling CRS, especially when the logs are being monitored and the deployment can be rolled back if the alerts start to pile up.</p><p>Using sampling mode means that CRS offers relatively little security if the sampling percentage is set to be low. The idea, however, is to increase the percentage over time, from 1% to 2%, to 5%, 10%, 20%, 50%, and ultimately to 100%, where the rules are applied to all traffic.</p><p><strong>The default sampling percentage of CRS is 100%.</strong> As such, if sampling is not of interest then the option can be safely ignored.</p><h2 id=applying-sampling-mode>Applying Sampling Mode</h2><p>Sampling mode is controlled by setting the <em>sampling percentage</em>. This is defined in the <code>crs-setup.conf</code> configuration file and can be found in the rule with ID 900400. To use sampling mode, uncomment this rule and set the variable <code>tx.sampling_percentage</code> to the desired value:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span>SecAction <span style=color:#960050;background-color:#1e0010>&#34;</span>id:900400,\
</span></span><span style=display:flex><span>  phase:1,\
</span></span><span style=display:flex><span>  pass,\
</span></span><span style=display:flex><span>  nolog,\
</span></span><span style=display:flex><span>  setvar:tx.sampling_percentage=50<span style=color:#960050;background-color:#1e0010>&#34;</span>
</span></span></code></pre></div><p>To test sampling mode, set the sampling percentage to 50 (which represents 50%), reload the server, and issue a few requests featuring a payload resembling an exploit. For example:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ curl -v http://localhost/index.html?test<span style=color:#f92672>=</span>/etc/passwd
</span></span></code></pre></div><ul><li>If the Core Rule Set is applied to the transaction <em>(and the inbound anomaly threshold is set to 10 or lower)</em> then a <code>403 Forbidden</code> status code will be returned, since the request causes two critical rules to match, by default.</li><li>If sampling mode is triggered for the transaction (with a 50% probability) then the rule set will be bypassed and an ordinary response will be received, e.g. a <code>200 OK</code> status code.</li></ul><p>In the latter case, where sampling mode is triggered and CRS is bypassed, an alert like the following can be found in the error log:</p><pre tabindex=0><code>[Wed Jan 01 00:00:00.123456 2022] [:error] [pid 3728:tid 139664291870464] [client 10.0.0.1:0] [client 10.0.0.1] ModSecurity: Warning. Match of &#34;lt %{tx.sampling_percentage}&#34; against &#34;TX:sampling_rnd100&#34; required. [file &#34;/etc/crs/rules/REQUEST-901-INITIALIZATION.conf&#34;] [line &#34;434&#34;] [id &#34;901450&#34;] [msg &#34;Sampling: Disable the rule engine based on sampling_percentage 50 and random number 81&#34;] [ver &#34;OWASP_CRS/3.3.2&#34;] [hostname &#34;www.example.com&#34;] [uri &#34;/index.html&#34;] [unique_id &#34;YgBKx4BqNoKe-XoGhPCPtAAAAIQ&#34;]
</code></pre><p>Here, CRS reports that it disabled the rule engine because the random number was above the sampling limit. The sampling percentage is set at the desired level, the rule set generates a random integer in the range 0-99 per-transaction, and if it’s <em>above</em> the sampling percentage then the WAF is disabled for the remainder of the transaction.</p><div class="notices warning"><div class=label>Warning</div><p>As sampling mode works by selectively disabling the ModSecurity WAF engine, if <em>other rule sets</em> are installed then they will be bypassed too.</p></div><ul><li>For requests where the rule set is bypassed, a log entry is emitted by rule 901450.</li><li>For the other requests, those without a corresponding 901450 entry, the rule set is applied normally.</li></ul><h3 id=disabling-sampling-mode-log-entries>Disabling Sampling Mode Log Entries</h3><p>If the log entires generated by rule 901450 seem excessive in volume then the rule can be silenced by applying the following directive, either after the CRS include statement or in the file <code>RESPONSE-999-EXCLUSION-RULES-AFTER-CRS.conf</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-apache data-lang=apache><span style=display:flex><span>SecRuleUpdateActionById <span style=color:#ae81ff>901450</span> <span style=color:#e6db74>&#34;nolog&#34;</span>
</span></span></code></pre></div><h2 id=rollback>Rollback</h2><p>If CRS is deployed in front of a large service and sampling mode is in use, with a low sampling rate defined, if the logs <em>still</em> start piling up then it may be desirable to completely disable CRS. Rather than carrying out a full rollback of the deployment, the quickest solution is to define <code>tx.sampling_percentage</code> to be 0, which means that <em>every request will bypass the WAF</em> (a sampling percentage of 0%: &ldquo;sample 0% of traffic&rdquo;). This will take effect once the web server has been reloaded so that it picks up the modified configuration. This leaves ModSecurity and CRS installed and ready for use, but completely disabled.</p><h2 id=random-number-generation>Random Number Generation</h2><p>ModSecurity has no built-in functionality to return random numbers, forcing CRS to find entropy for itself. It does this by taking advantage of the fact that the <code>UNIQUE_ID</code> variable, which identifies each request with a token that&rsquo;s guaranteed to be unique, has a random element to it. This is the entropy that&rsquo;s used for sampling.</p><p>Rule 901410 hashes the unique ID and encodes the result as a string of hexadecimal characters. The first two <em>digits</em> of the string are then extracted to get a random number from 0 to 99. In the extremely rare case where the hex encoded hash doesn&rsquo;t contain a digit, there&rsquo;s a fallback routine in place which takes the last digits of the <code>DURATION</code> variable.</p><p>The random numbers generated using this method are not cryptographically secure, but they are sufficient for the purposes of sampling.</p><footer class=footline></footer></main></div><div id=navigation><a class="nav nav-prev" href=/documentation/concepts/plugins/ title="Plugin Mechanism"><i class="fa fa-chevron-left"></i></a>
<a class="nav nav-next" href=/documentation/operation/ title=Operation><i class="fa fa-chevron-right"></i></a></div></div><div style=left:-1000px;overflow:scroll;position:absolute;top:-1000px;border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px><div style=border:none;box-sizing:content-box;height:200px;margin:0;padding:0;width:200px></div></div><script src=/documentation/js/clipboard.min.js?1681766460></script>
<script src=/documentation/js/perfect-scrollbar.min.js?1681766460></script>
<script src=/documentation/js/perfect-scrollbar.jquery.min.js?1681766460></script>
<script src=/documentation/js/jquery.svg.pan.zoom.js?1681766460></script>
<script src=/documentation/js/featherlight.min.js?1681766460></script>
<script src=/documentation/js/modernizr.custom-3.6.0.js?1681766460></script>
<script src=/documentation/js/mermaid.min.js?1681766460></script>
<script>typeof mermaid!="undefined"&&mermaid.mermaidAPI.initialize(Object.assign({securityLevel:"antiscript"},JSON.parse('{ "startOnLoad": true }'),{startOnLoad:!1}))</script><script src=/documentation/js/relearn.js?1681766460></script>
<script>var _paq=window._paq=window._paq||[];_paq.push(["trackPageView"]),_paq.push(["enableLinkTracking"]),function(){e="https://piwik.netnea.com/matomo/",_paq.push(["setTrackerUrl",e+"matomo.php"]),_paq.push(["setSiteId","4"]);var e,n=document,t=n.createElement("script"),s=n.getElementsByTagName("script")[0];t.async=!0,t.src=e+"matomo.js",s.parentNode.insertBefore(t,s)}()</script><img referrerpolicy=no-referrer-when-downgrade src="https://piwik.netnea.com/matomo/matomo.php?idsite=4&rec=1" style=border:0 alt></body></html>